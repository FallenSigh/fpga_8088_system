# MPE - 8088微处理器FPGA系统

![FPGA](https://img.shields.io/badge/FPGA-Cyclone%20IV%20E-blue)
![Quartus](https://img.shields.io/badge/Quartus-22.1std.2-green)
![8088](https://img.shields.io/badge/CPU-8088-red)
![Status](https://img.shields.io/badge/Status-已完成上板测试-success)
![中断系统](https://img.shields.io/badge/中断-4键IR1中断优化-orange)
![构建](https://img.shields.io/badge/构建-自动化脚本-brightgreen)

一个完整的8088微处理器系统在FPGA上的实现，集成了多种经典外设芯片，实现了x86兼容的计算机系统。项目已完成上板测试，支持完整的软硬件协同开发。

## 📋 项目简介

MPE（MicroProcessor Experiment）是一个基于Intel Cyclone IV E FPGA的8088微处理器系统项目。该项目完整实现了8088 CPU核心、系统总线、存储器以及多种经典外设，提供了一个完整的x86兼容计算机系统平台。

**项目目标：**
- 在FPGA上实现完整的8088微处理器系统
- 集成8259、8254、8255等经典外设芯片
- 提供软硬件协同开发环境
- 支持教学和实验用途
- 实现完整的按键中断系统（4个按键统一使用IR1中断）

**项目特点：**
- ✅ **已完成上板测试** - 所有功能均已验证
- ✅ **中断系统优化** - 4个按键统一使用IR1中断，消除轮询开销
- ✅ **完整的软硬件协同** - 汇编程序与硬件设计紧密结合
- ✅ **自动化构建流程** - 一键编译汇编程序和FPGA项目
- ✅ **丰富的调试接口** - 串口调试、LED状态显示、测试信号输出

## ✨ 特性

### 🖥️ 硬件特性
- **处理器核心**：完整的8088微处理器实现 (gw8088.vqm)
- **存储系统**：16KB RAM + 16KB ROM
- **系统总线**：支持CPU/DMA仲裁的20位地址总线
- **时钟系统**：50MHz主时钟，PLL分频生成多路时钟
- **中断系统**：8259 PIC管理8个中断源，4个按键统一使用IR1中断
- **外设集成**：
  - 8259 可编程中断控制器 (PIC) - 中断管理
  - 8254 可编程间隔定时器 (PIT) - 定时中断生成
  - 8255 可编程并行接口 (PPI) - 按键输入和LED控制
  - 8237 DMA控制器 - 直接存储器访问
  - 16550 UART串口控制器 - 串口通信 (115200波特率)
  - 74HC595 LED/数码管显示控制 - 状态显示
- **调试接口**：丰富的测试信号输出，便于硬件调试

### 💾 软件特性
- **汇编支持**：完整的8088汇编程序开发环境 (MASM语法)
- **中断系统**：完整的中断向量表和中断处理程序
- **外设驱动**：所有外设的初始化和管理程序
- **按键处理**：4个按键的中断处理，支持暂停、方向切换、速度切换等功能
- **定时器应用**：8254定时器中断实现1ms定时
- **显示控制**：数码管动态扫描显示和LED状态控制
- **串口通信**：16550 UART串口通信，支持调试信息输出
- **自动化构建**：一键编译脚本，自动生成ROM镜像

## 🏗️ 系统架构

### 地址空间映射
```
内存空间 (1MB):
  0x00000 - 0x03FFF: RAM (16KB)
  0xFC000 - 0xFFFFF: ROM (16KB)

IO空间 (标准PC映射):
  0x00 - 0x0F: DMA控制器 (8237)
  0x20 - 0x21: 中断控制器 (8259)
  0x40 - 0x43: 定时器 (8254)
  0x60 - 0x63: 并行接口 (8255)
  0x3F8 - 0x3FF: 串口控制器 (16550)
```

### 总线架构
- **20位地址总线**，支持1MB寻址空间
- **8位数据总线**
- **总线仲裁**：支持CPU和DMA之间的动态总线切换
- **地址译码**：完整的存储器映射和IO映射

### 中断系统架构
系统采用优化的中断设计，4个按键统一使用IR1中断，通过8255端口C读取具体按键状态：

```
中断源分配：
- IR0: 定时器中断 (8254通道0输出) - 1ms定时
- IR1: 按键中断 (4个按键统一) - 按键事件处理
- IR2-IR7: 保留

按键处理流程：
1. 按键按下 → 产生IR1中断
2. CPU响应中断，进入中断处理程序
3. 读取8255端口C获取具体按键状态
4. 根据按键执行相应功能
5. 发送EOI命令，中断返回
```

这种设计消除了轮询开销，提高了系统响应效率。

## 🚀 快速开始

### 环境要求
- **FPGA开发工具**：Intel Quartus Prime 22.1std.2或更高版本
- **汇编工具**：MASM汇编器 (Microsoft Macro Assembler)
- **Python 3**：用于二进制文件转换
- **硬件平台**：Cyclone IV E EP4CE10F17C8开发板

### 详细构建步骤

#### 1. 准备开发环境
确保已安装以下工具：
- **Intel Quartus Prime 22.1std.2** (或更高版本)
- **MASM汇编器** (包含ml.exe, link.exe)
- **Python 3** (用于exe2hex.py脚本)

将MASM工具复制到`asm/`目录，或设置系统PATH环境变量。

#### 2. 汇编程序构建
```bash
# 进入汇编目录
cd asm/

# 执行一键构建脚本
build.bat main

# 详细构建过程：
# 1. ml /c /Fl main.asm      - 汇编生成main.obj和main.lst列表文件
# 2. link main.obj           - 链接生成main.exe可执行文件
# 3. python exe2hex.py main.exe rom.hex - 转换为16KB Intel HEX格式
# 4. 自动清理临时文件 (main.exe, main.obj等)

# 构建成功后会生成：
# - rom.hex: 16KB ROM镜像文件，用于FPGA
# - main.lst: 汇编列表文件，便于调试
```

**注意**：如果程序超过16KB，构建会失败。请优化代码或减少功能。

#### 3. FPGA项目编译 (Quartus Prime)
1. **打开项目**：启动Quartus Prime，打开`quartus_project/mpe.qsf`
2. **完整编译流程**：
   - **Analysis & Synthesis** - 分析和综合
   - **Fitter (Place & Route)** - 布局布线
   - **Assembler** - 生成编程文件
   - **Timing Analysis** - 时序分析
3. **编译输出**：成功后在`quartus_project/output_files/`目录生成：
   - `mpe.sof` - SRAM对象文件，用于JTAG编程
   - `mpe.pof` - 编程对象文件，用于配置器件
   - 各种报告文件 (时序报告、资源使用报告等)

#### 4. 下载到FPGA
1. **连接编程器**：使用USB-Blaster或其他兼容编程器
2. **打开Programmer**：在Quartus中打开Programmer工具
3. **添加文件**：添加`mpe.sof`文件
4. **编程选项**：确保选中"Program/Configure"
5. **开始编程**：点击Start按钮下载到FPGA
6. **系统启动**：编程完成后系统自动启动运行

#### 5. 验证系统运行
系统启动后可通过以下方式验证：
- **LED指示灯**：观察LED状态变化
- **数码管显示**：显示计时器数值
- **串口输出**：连接串口终端(115200波特率)查看调试信息
- **按键测试**：按下4个按键测试中断功能

## 📁 目录结构

```
MPE/
├── asm/                    # 8088汇编程序
│   ├── main.asm           # 主汇编程序 (包含中断处理、按键处理、显示控制等)
│   ├── build.bat          # 汇编构建脚本 (Windows批处理)
│   ├── exe2hex.py         # EXE转HEX转换脚本 (Python)
│   ├── rom.hex            # 生成的ROM镜像 (16KB Intel HEX格式)
│   ├── main.lst           # 汇编列表文件 (构建生成)
│   └── (需自行准备MASM工具: ml.exe, link.exe等)
├── quartus_project/        # Quartus FPGA项目文件
│   ├── top.bdf            # 顶层Block Diagram设计 (图形化设计)
│   ├── mpe.qsf            # Quartus项目设置文件
│   ├── pin.tcl            # FPGA引脚分配文件 (Tcl脚本)
│   ├── mpe_assignment_defaults.qdf  # 默认引脚分配
│   ├── *.bsf              # 各种Block Symbol文件 (外设符号)
│   ├── output_files/      # 编译输出文件目录 (生成)
│   │   ├── mpe.sof        # SRAM对象文件 (JTAG编程)
│   │   └── mpe.pof        # 编程对象文件 (配置器件)
│   └── db/                # 数据库文件 (Quartus生成)
├── rtl/                    # Verilog RTL源代码
│   ├── mpe.v              # 主系统模块 (顶层模块)
│   ├── system_bus.v       # 系统总线控制器 (地址译码、总线仲裁)
│   ├── hc595_ctrl.v       # 74HC595移位寄存器控制 (数码管显示)
│   ├── uart_clk.v         # UART时钟生成模块 (1.8432MHz)
│   ├── pit_clk.v          # 定时器时钟生成模块 (1MHz)
│   ├── rst_sync.v         # 复位同步模块
│   ├── pll/               # PLL时钟模块 (50MHz→多路时钟)
│   ├── ram/               # RAM存储器模块 (16KB)
│   ├── rom/               # ROM存储器模块 (16KB)
│   └── gw*.vqm            # 各种外设IP核文件 (8088 CPU、8259、8254等)
├── testbench/             # 测试文件
│   └── tb_top.v           # 顶层测试文件 (功能仿真)
├── .spec-workflow/        # 项目规范工作流模板
│   ├── requirements-template.md    # 需求文档模板
│   ├── design-template.md          # 设计文档模板
│   ├── tasks-template.md           # 任务文档模板
│   └── user-templates/             # 用户自定义模板
├── .gitignore            # Git忽略文件配置
├── CLAUDE.md             # Claude Code助手文档 (项目指南)
└── README.md             # 项目说明文档 (本文件)
```

## 🔧 硬件规格

### FPGA器件
- **型号**：Intel Cyclone IV E EP4CE10F17C8
- **逻辑单元**：10,320 LE
- **存储器**：414 Kbits
- **封装**：256-pin FineLine BGA

### 引脚分配
| 信号 | 引脚 | 说明 |
|------|------|------|
| `clk` | PIN_E1 | 系统时钟输入 (50MHz) |
| `rst_n` | PIN_M15 | 系统复位 (低电平有效) |
| `led[3:0]` | PIN_L7, M6, P3, N3 | LED状态指示灯 |
| `uart_tx` | PIN_N5 | 串口发送 |
| `uart_rx` | PIN_N6 | 串口接收 |
| `stcp` | PIN_K9 | 74HC595存储寄存器时钟 |
| `shcp` | PIN_B1 | 74HC595移位寄存器时钟 |
| `ds` | PIN_R1 | 74HC595串行数据输入 |
| `oe` | PIN_L11 | 74HC595输出使能 |

### 时钟系统
- **主时钟**：50MHz 外部晶振
- **系统时钟**：25MHz (PLL分频)
- **UART时钟**：1.8432MHz (标准波特率时钟)
- **定时器时钟**：1MHz (8254定时器时钟)

## 💻 软件开发

### 汇编程序开发
汇编程序位于`asm/main.asm`，包含以下功能：

1. **系统初始化**
   ```assembly
   ; 初始化8259中断控制器
   mov al, 0x13        ; ICW1: 边沿触发，单片8259
   out 0x20, al
   mov al, 0x08        ; ICW2: 中断向量基址0x08
   out 0x21, al
   mov al, 0x01        ; ICW4: 8086模式
   out 0x21, al
   ```

2. **外设初始化**
   - 8254定时器配置
   - 8255并行接口配置
   - 16550串口配置

3. **应用程序**
   - LED控制程序
   - 数码管显示程序
   - 串口通信程序
   - 中断处理程序

### 构建脚本
`asm/build.bat` 自动化构建脚本：
```batch
@echo off
if "%1"=="" (
    echo Usage: build.bat <basename>
    echo Example: build.bat main
    exit /b 1
)

set NAME=%1
ml /c /Fl %NAME%.asm
link %NAME%.obj < nul
python exe2hex.py %NAME%.exe rom.hex
rm %NAME%.exe
rm %NAME%.obj
```

### ROM转换工具
`asm/exe2hex.py` 将EXE文件转换为16KB Intel HEX格式：
- 自动解析DOS MZ头
- 提取代码段数据
- 填充到16KB固定大小
- 生成Intel HEX格式文件

## 🛠️ 硬件开发

### RTL设计
主要RTL模块：

1. **`mpe.v`** - 顶层系统模块
   - 实例化所有子模块
   - 时钟和复位管理
   - 外部接口定义

2. **`system_bus.v`** - 系统总线控制器
   - 地址译码逻辑
   - 总线仲裁逻辑 (CPU/DMA)
   - 数据总线多路复用

3. **`hc595_ctrl.v`** - 74HC595控制
   - 串行转并行数据转换
   - LED和数码管显示控制

### Block Diagram设计
`quartus_project/top.bdf` 提供了图形化的系统设计：
- 8088 CPU核心连接
- 外设芯片互连
- 时钟网络设计
- 复位电路设计

### 引脚约束
`quartus_project/pin.tcl` 定义所有FPGA引脚分配：
```tcl
set_location_assignment PIN_E1 -to clk
set_location_assignment PIN_M15 -to rst_n
set_location_assignment PIN_L7 -to led[0]
# ... 更多引脚定义
```

## 🧪 测试验证

### 仿真测试
使用`testbench/tb_top.v`进行功能仿真：
```verilog
module tb_top;
    // 时钟和复位生成
    reg clk = 0;
    reg rst_n = 0;

    // 实例化被测系统
    mpe uut (
        .clk(clk),
        .rst_n(rst_n),
        // ... 其他信号连接
    );

    // 测试激励
    initial begin
        // 复位序列
        #100 rst_n = 1;

        // 运行测试
        #10000 $finish;
    end

    // 时钟生成
    always #10 clk = ~clk; // 50MHz时钟
endmodule
```

### 上板测试结果 (已完成)
项目已完成全面的上板测试，所有功能均验证通过：

#### 1. 基本功能测试 ✅
- **系统启动**：复位后系统正常启动，执行ROM中的汇编程序
- **时钟系统**：50MHz主时钟、25MHz系统时钟、1.8432MHz UART时钟均正常
- **复位电路**：复位信号有效，系统可正常复位重启
- **电源管理**：电源稳定，无异常功耗

#### 2. 外设功能测试 ✅
- **8259中断控制器**：
  - 中断向量设置正确 (IR0: 0x08, IR1: 0x09)
  - 中断屏蔽寄存器功能正常
  - EOI命令正确发送
- **8254定时器**：
  - 通道0配置为模式3 (方波发生器)
  - 1ms定时中断稳定产生
  - 定时精度符合要求
- **8255并行接口**：
  - 端口A/B/C方向配置正确
  - 按键输入读取准确 (4个按键)
  - LED输出控制正常
- **16550串口**：
  - 波特率115200配置正确
  - 串口收发功能正常
  - 调试信息输出完整
- **74HC595显示**：
  - 数码管动态扫描显示正常
  - LED状态指示清晰
  - 串行数据传输稳定

#### 3. 中断系统测试 ✅
- **定时器中断**：IR0中断每1ms触发一次，用于系统计时
- **按键中断**：IR1中断响应4个按键，中断处理程序正确识别按键
- **中断嵌套**：支持中断嵌套，优先级正确
- **中断响应时间**：符合8088处理器时序要求

#### 4. 应用程序测试 ✅
- **计时器功能**：数码管显示计时数值，精度1ms
- **按键控制**：
  - 按键1: 暂停/继续计时
  - 按键2: 切换计时方向 (正计时/倒计时)
  - 按键3: 切换计时速度 (正常/10倍速)
  - 按键4: 复位计时器
- **状态显示**：LED指示灯显示系统状态
- **串口调试**：通过串口输出系统状态和调试信息

#### 5. 性能测试 ✅
- **时钟频率**：系统稳定运行在25MHz
- **存储器访问**：RAM/ROM读写正确，无访问冲突
- **中断延迟**：中断响应时间在可接受范围内
- **资源使用**：FPGA资源使用合理，有余量

## ❓ 常见问题

### Q1: 系统无法启动
**可能原因：**
- 时钟信号异常
- 复位信号未正确释放
- FPGA配置失败

**解决方案：**
1. 检查时钟源和时钟引脚连接
2. 验证复位电路和复位信号
3. 重新下载FPGA配置文件

### Q2: 外设不工作
**可能原因：**
- 片选信号未正确生成
- 初始化序列错误
- 地址映射不匹配

**解决方案：**
1. 检查`system_bus.v`中的地址译码逻辑
2. 验证汇编程序中的外设初始化代码
3. 使用逻辑分析仪检查控制信号

### Q3: 中断不触发
**可能原因：**
- 8259配置错误
- 中断屏蔽位设置
- 中断向量表错误
- 按键中断线路连接问题

**解决方案：**
1. 检查8259初始化序列 (ICW1-ICW4)
2. 验证中断屏蔽寄存器设置 (OCW1)
3. 确认中断向量表位置和内容
4. 检查按键电路和8255端口C连接
5. 验证IR1中断线路是否正常

### Q4: 按键中断无法区分具体按键
**可能原因：**
- 8255端口C读取错误
- 按键去抖处理不当
- 中断处理程序逻辑错误

**解决方案：**
1. 检查8255控制字设置 (端口C输入模式)
2. 在中断处理程序中正确读取端口C状态
3. 添加软件去抖逻辑
4. 验证按键编码与处理逻辑匹配

### Q5: ROM程序超过16KB限制
**可能原因：**
- 汇编程序代码过大
- 数据段占用过多空间

**解决方案：**
1. 优化代码，移除不必要的功能
2. 使用代码压缩技术
3. 考虑扩展ROM容量
4. 减少数据段大小，使用动态分配

## 🤝 贡献指南

欢迎贡献代码和文档！请遵循以下步骤：

1. **Fork项目**
2. **创建功能分支**
   ```bash
   git checkout -b feature/新功能
   ```
3. **提交更改**
   ```bash
   git commit -m "添加: 新功能描述"
   ```
4. **推送到分支**
   ```bash
   git push origin feature/新功能
   ```
5. **创建Pull Request**

### 代码规范
- Verilog代码遵循IEEE 1364标准
- 汇编代码使用MASM语法
- 注释使用中文或英文，保持清晰
- 模块接口文档完整

### 文档规范
- 使用Markdown格式
- 包含必要的代码示例
- 更新相关文档和注释

## 📄 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 📞 联系与支持

如有问题或建议，请通过以下方式联系：

- **问题反馈**：在GitHub Issues中提交问题
- **功能请求**：创建Feature Request Issue
- **文档改进**：提交Pull Request更新文档

## 📊 项目状态

### 版本信息
- **当前版本**：v1.0 (稳定版)
- **最后更新**：2025年12月24日
- **FPGA器件**：Cyclone IV E EP4CE10F17C8
- **Quartus版本**：22.1std.2 Lite Edition
- **最后编译时间**：2025年12月13日

### 功能状态
- ✅ **硬件系统**：已完成上板测试，所有功能验证通过
- ✅ **中断系统**：4个按键统一使用IR1中断，优化完成
- ✅ **外设驱动**：8259、8254、8255、16550等外设驱动完善
- ✅ **应用程序**：计时器应用功能完整，支持按键控制
- ✅ **构建流程**：自动化构建脚本，一键编译
- ✅ **文档资料**：README、CLAUDE.md等文档完善

### 测试状态
- ✅ **功能测试**：所有外设功能测试通过
- ✅ **中断测试**：定时器中断和按键中断测试通过
- ✅ **性能测试**：系统稳定运行在25MHz
- ✅ **兼容性测试**：与标准8088系统兼容

### 未来计划
- 🔄 **功能扩展**：考虑添加更多外设支持
- 🔄 **性能优化**：进一步优化中断响应时间
- 🔄 **应用开发**：开发更多示例应用程序
- 🔄 **文档完善**：添加更详细的设计文档和教程

---

**致谢**：感谢所有为项目做出贡献的开发者和测试人员！

**注意**：本项目主要用于教学和实验目的，部分功能可能仍在开发中。